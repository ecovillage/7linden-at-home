#!/bin/bash
# Copyright 2015, 2016 Felix Wolfsteller
# Released under the GPL

# Check whether our gateway is 7 Linden router
# Return 0 if at home.

set -e

readonly CP_HOST="192.168.0.1"

fifo="/tmp/$(basename $0)-$$"

am_at_home() {
  mkfifo "$fifo"
  grep "ssh-rsa" /opt/7linden-at-home/data/host_keys 2> /dev/null > "$fifo" &
  /usr/bin/ssh-keyscan -T1 -t rsa "$CP_HOST" 2> /dev/null | sort | \
  diff "$fifo" - > /dev/null 2>&1
  ret=$?
  rm "$fifo"
  return "$ret"
}

main() {
  if am_at_home; then
    # Post login info
    exit 0
  else
    #  ; # Nothing to do
    echo "Not at home"
    exit 1
  fi
}

main
